# VPN-Server durch häufige Client-Reconnects instabil (CHC-883)

Testgerät `motis-dev` Initial verbunden mit VPN IP 172.20.172.80

Netzwerkverbindung getrennt um: Sep 04 16:40:46

Neuer Verbindungsversuch (`soft,ping-restart`) um 16:42:46 nach 120 Sekunden:
`Inactivity timeout (--ping-restart), restarting`

Gleichzeitig loggt Server auch:
```
Time		Sep/04/2025 14:42:48
Message		motis-dev logged out, 482 14761 4599 77 56 from 104.151.25.82

Time		Sep/04/2025 14:42:48
Message		<ovpn-motis-dev>: disconnected

Time		Sep/04/2025 14:42:47
Message		<ovpn-motis-dev>: terminating... - nothing received for a while
```

Danach folgende Sekunden-Abstände zwischen Verbindungsversuchen:
5, 5, 5, 10, 20, 40, 80, 160, 300, 300, 300

Das entspricht einer `connect retry 5 300` Konfiguration

Wiederherstellen der Internetverbindung um 16:59:29 
Nach Ablauf der 300s-Restart Pause um 17:03:26 baut sich die Verbindung wieder auf.
Gerät (motis-dev) behält die vorherige IP-Adresse (172.20.172.80).

Log Client (`openvpn@ovpn.service`)

```
Sep 04 16:42:46 motis-dev ovpn-ovpn[1347]: [grs.smight-mgt.de] Inactivity timeout (--ping-restart), restarting
Sep 04 16:42:46 motis-dev ovpn-ovpn[1347]: TCP/UDP: Closing socket
Sep 04 16:42:46 motis-dev ovpn-ovpn[1347]: SIGUSR1[soft,ping-restart] received, process restarting
Sep 04 16:42:46 motis-dev ovpn-ovpn[1347]: Restart pause, 5 second(s)
Sep 04 16:42:51 motis-dev ovpn-ovpn[1347]: NOTE: the current --script-security setting may allow this configuration to call user-defined scripts
Sep 04 16:42:51 motis-dev ovpn-ovpn[1347]: Re-using SSL/TLS context
Sep 04 16:42:51 motis-dev ovpn-ovpn[1347]: Control Channel MTU parms [ L:1623 D:1210 EF:40 EB:0 ET:0 EL:3 ]
Sep 04 16:42:51 motis-dev ovpn-ovpn[1347]: Data Channel MTU parms [ L:1623 D:1450 EF:123 EB:406 ET:0 EL:3 ]
Sep 04 16:42:51 motis-dev ovpn-ovpn[1347]: Local Options String (VER=V4): 'V4,dev-type tun,link-mtu 1559,tun-mtu 1500,proto TCPv4_CLIENT,cipher AES-128-CBC,auth SHA1,keysize 128,key-method 2,tls-client'
Sep 04 16:42:51 motis-dev ovpn-ovpn[1347]: Expected Remote Options String (VER=V4): 'V4,dev-type tun,link-mtu 1559,tun-mtu 1500,proto TCPv4_SERVER,cipher AES-128-CBC,auth SHA1,keysize 128,key-method 2,tls-server'
Sep 04 16:42:51 motis-dev ovpn-ovpn[1347]: TCP/UDP: Preserving recently used remote address: [AF_INET]185.126.28.27:1194
Sep 04 16:42:51 motis-dev ovpn-ovpn[1347]: Socket Buffers: R=[131072->131072] S=[16384->16384]
Sep 04 16:42:51 motis-dev ovpn-ovpn[1347]: Attempting to establish TCP connection with [AF_INET]185.126.28.27:1194 [nonblock]
Sep 04 16:42:51 motis-dev ovpn-ovpn[1347]: TCP: connect to [AF_INET]185.126.28.27:1194 failed: Network is unreachable
Sep 04 16:42:51 motis-dev ovpn-ovpn[1347]: SIGUSR1[connection failed(soft),init_instance] received, process restarting
Sep 04 16:42:51 motis-dev ovpn-ovpn[1347]: Restart pause, 5 second(s)
Sep 04 16:42:56 motis-dev ovpn-ovpn[1347]: NOTE: the current --script-security setting may allow this configuration to call user-defined scripts
Sep 04 16:42:56 motis-dev ovpn-ovpn[1347]: Re-using SSL/TLS context
Sep 04 16:42:56 motis-dev ovpn-ovpn[1347]: Control Channel MTU parms [ L:1623 D:1210 EF:40 EB:0 ET:0 EL:3 ]
Sep 04 16:42:56 motis-dev ovpn-ovpn[1347]: Data Channel MTU parms [ L:1623 D:1450 EF:123 EB:406 ET:0 EL:3 ]
Sep 04 16:42:56 motis-dev ovpn-ovpn[1347]: Local Options String (VER=V4): 'V4,dev-type tun,link-mtu 1559,tun-mtu 1500,proto TCPv4_CLIENT,cipher AES-128-CBC,auth SHA1,keysize 128,key-method 2,tls-client'
Sep 04 16:42:56 motis-dev ovpn-ovpn[1347]: Expected Remote Options String (VER=V4): 'V4,dev-type tun,link-mtu 1559,tun-mtu 1500,proto TCPv4_SERVER,cipher AES-128-CBC,auth SHA1,keysize 128,key-method 2,tls-server'
Sep 04 16:42:56 motis-dev ovpn-ovpn[1347]: TCP/UDP: Preserving recently used remote address: [AF_INET]185.126.28.27:1194
Sep 04 16:42:56 motis-dev ovpn-ovpn[1347]: Socket Buffers: R=[131072->131072] S=[16384->16384]
Sep 04 16:42:56 motis-dev ovpn-ovpn[1347]: Attempting to establish TCP connection with [AF_INET]185.126.28.27:1194 [nonblock]
Sep 04 16:42:56 motis-dev ovpn-ovpn[1347]: TCP: connect to [AF_INET]185.126.28.27:1194 failed: Network is unreachable
Sep 04 16:42:56 motis-dev ovpn-ovpn[1347]: SIGUSR1[connection failed(soft),init_instance] received, process restarting
Sep 04 16:42:56 motis-dev ovpn-ovpn[1347]: Restart pause, 5 second(s)
Sep 04 16:43:01 motis-dev ovpn-ovpn[1347]: NOTE: the current --script-security setting may allow this configuration to call user-defined scripts
Sep 04 16:43:01 motis-dev ovpn-ovpn[1347]: Re-using SSL/TLS context
Sep 04 16:43:01 motis-dev ovpn-ovpn[1347]: Control Channel MTU parms [ L:1623 D:1210 EF:40 EB:0 ET:0 EL:3 ]
Sep 04 16:43:01 motis-dev ovpn-ovpn[1347]: Data Channel MTU parms [ L:1623 D:1450 EF:123 EB:406 ET:0 EL:3 ]
Sep 04 16:43:01 motis-dev ovpn-ovpn[1347]: Local Options String (VER=V4): 'V4,dev-type tun,link-mtu 1559,tun-mtu 1500,proto TCPv4_CLIENT,cipher AES-128-CBC,auth SHA1,keysize 128,key-method 2,tls-client'
Sep 04 16:43:01 motis-dev ovpn-ovpn[1347]: Expected Remote Options String (VER=V4): 'V4,dev-type tun,link-mtu 1559,tun-mtu 1500,proto TCPv4_SERVER,cipher AES-128-CBC,auth SHA1,keysize 128,key-method 2,tls-server'
Sep 04 16:43:01 motis-dev ovpn-ovpn[1347]: TCP/UDP: Preserving recently used remote address: [AF_INET]185.126.28.27:1194
Sep 04 16:43:01 motis-dev ovpn-ovpn[1347]: Socket Buffers: R=[131072->131072] S=[16384->16384]
Sep 04 16:43:01 motis-dev ovpn-ovpn[1347]: Attempting to establish TCP connection with [AF_INET]185.126.28.27:1194 [nonblock]
Sep 04 16:43:01 motis-dev ovpn-ovpn[1347]: TCP: connect to [AF_INET]185.126.28.27:1194 failed: Network is unreachable
Sep 04 16:43:01 motis-dev ovpn-ovpn[1347]: SIGUSR1[connection failed(soft),init_instance] received, process restarting
Sep 04 16:43:01 motis-dev ovpn-ovpn[1347]: Restart pause, 5 second(s)
Sep 04 16:43:06 motis-dev ovpn-ovpn[1347]: NOTE: the current --script-security setting may allow this configuration to call user-defined scripts
Sep 04 16:43:06 motis-dev ovpn-ovpn[1347]: Re-using SSL/TLS context
Sep 04 16:43:06 motis-dev ovpn-ovpn[1347]: Control Channel MTU parms [ L:1623 D:1210 EF:40 EB:0 ET:0 EL:3 ]
Sep 04 16:43:06 motis-dev ovpn-ovpn[1347]: Data Channel MTU parms [ L:1623 D:1450 EF:123 EB:406 ET:0 EL:3 ]
Sep 04 16:43:06 motis-dev ovpn-ovpn[1347]: Local Options String (VER=V4): 'V4,dev-type tun,link-mtu 1559,tun-mtu 1500,proto TCPv4_CLIENT,cipher AES-128-CBC,auth SHA1,keysize 128,key-method 2,tls-client'
Sep 04 16:43:06 motis-dev ovpn-ovpn[1347]: Expected Remote Options String (VER=V4): 'V4,dev-type tun,link-mtu 1559,tun-mtu 1500,proto TCPv4_SERVER,cipher AES-128-CBC,auth SHA1,keysize 128,key-method 2,tls-server'
Sep 04 16:43:06 motis-dev ovpn-ovpn[1347]: TCP/UDP: Preserving recently used remote address: [AF_INET]185.126.28.27:1194
Sep 04 16:43:06 motis-dev ovpn-ovpn[1347]: Socket Buffers: R=[131072->131072] S=[16384->16384]
Sep 04 16:43:06 motis-dev ovpn-ovpn[1347]: Attempting to establish TCP connection with [AF_INET]185.126.28.27:1194 [nonblock]
Sep 04 16:43:06 motis-dev ovpn-ovpn[1347]: TCP: connect to [AF_INET]185.126.28.27:1194 failed: Network is unreachable
Sep 04 16:43:06 motis-dev ovpn-ovpn[1347]: SIGUSR1[connection failed(soft),init_instance] received, process restarting
Sep 04 16:43:06 motis-dev ovpn-ovpn[1347]: Restart pause, 5 second(s)

...

Sep 04 16:53:26 motis-dev ovpn-ovpn[1347]: Restart pause, 300 second(s)
Sep 04 16:58:26 motis-dev ovpn-ovpn[1347]: NOTE: the current --script-security setting may allow this configuration to call user-defined scripts
Sep 04 16:58:26 motis-dev ovpn-ovpn[1347]: Re-using SSL/TLS context
Sep 04 16:58:26 motis-dev ovpn-ovpn[1347]: Control Channel MTU parms [ L:1623 D:1210 EF:40 EB:0 ET:0 EL:3 ]
Sep 04 16:58:26 motis-dev ovpn-ovpn[1347]: Data Channel MTU parms [ L:1623 D:1450 EF:123 EB:406 ET:0 EL:3 ]
Sep 04 16:58:26 motis-dev ovpn-ovpn[1347]: Local Options String (VER=V4): 'V4,dev-type tun,link-mtu 1559,tun-mtu 1500,proto TCPv4_CLIENT,cipher AES-128-CBC,auth SHA1,keysize 128,key-method 2,tls-client'
Sep 04 16:58:26 motis-dev ovpn-ovpn[1347]: Expected Remote Options String (VER=V4): 'V4,dev-type tun,link-mtu 1559,tun-mtu 1500,proto TCPv4_SERVER,cipher AES-128-CBC,auth SHA1,keysize 128,key-method 2,tls-server'
Sep 04 16:58:26 motis-dev ovpn-ovpn[1347]: TCP/UDP: Preserving recently used remote address: [AF_INET]185.126.28.27:1194
Sep 04 16:58:26 motis-dev ovpn-ovpn[1347]: Socket Buffers: R=[131072->131072] S=[16384->16384]
Sep 04 16:58:26 motis-dev ovpn-ovpn[1347]: Attempting to establish TCP connection with [AF_INET]185.126.28.27:1194 [nonblock]
Sep 04 16:58:26 motis-dev ovpn-ovpn[1347]: TCP: connect to [AF_INET]185.126.28.27:1194 failed: Network is unreachable
Sep 04 16:58:26 motis-dev ovpn-ovpn[1347]: SIGUSR1[connection failed(soft),init_instance] received, process restarting
Sep 04 16:58:26 motis-dev ovpn-ovpn[1347]: Restart pause, 300 second(s)
Sep 04 17:03:26 motis-dev ovpn-ovpn[1347]: NOTE: the current --script-security setting may allow this configuration to call user-defined scripts
Sep 04 17:03:26 motis-dev ovpn-ovpn[1347]: Re-using SSL/TLS context
Sep 04 17:03:26 motis-dev ovpn-ovpn[1347]: Control Channel MTU parms [ L:1623 D:1210 EF:40 EB:0 ET:0 EL:3 ]
Sep 04 17:03:26 motis-dev ovpn-ovpn[1347]: Data Channel MTU parms [ L:1623 D:1450 EF:123 EB:406 ET:0 EL:3 ]
Sep 04 17:03:26 motis-dev ovpn-ovpn[1347]: Local Options String (VER=V4): 'V4,dev-type tun,link-mtu 1559,tun-mtu 1500,proto TCPv4_CLIENT,cipher AES-128-CBC,auth SHA1,keysize 128,key-method 2,tls-client'
Sep 04 17:03:26 motis-dev ovpn-ovpn[1347]: Expected Remote Options String (VER=V4): 'V4,dev-type tun,link-mtu 1559,tun-mtu 1500,proto TCPv4_SERVER,cipher AES-128-CBC,auth SHA1,keysize 128,key-method 2,tls-server'
Sep 04 17:03:26 motis-dev ovpn-ovpn[1347]: TCP/UDP: Preserving recently used remote address: [AF_INET]185.126.28.27:1194
Sep 04 17:03:26 motis-dev ovpn-ovpn[1347]: Socket Buffers: R=[131072->131072] S=[16384->16384]
Sep 04 17:03:26 motis-dev ovpn-ovpn[1347]: Attempting to establish TCP connection with [AF_INET]185.126.28.27:1194 [nonblock]
Sep 04 17:03:27 motis-dev ovpn-ovpn[1347]: TCP connection established with [AF_INET]185.126.28.27:1194
Sep 04 17:03:27 motis-dev ovpn-ovpn[1347]: TCP_CLIENT link local: (not bound)
Sep 04 17:03:27 motis-dev ovpn-ovpn[1347]: TCP_CLIENT link remote: [AF_INET]185.126.28.27:1194
Sep 04 17:03:27 motis-dev ovpn-ovpn[1347]: TLS: Initial packet from [AF_INET]185.126.28.27:1194, sid=5a5e7cdf f881a44b
Sep 04 17:03:27 motis-dev ovpn-ovpn[1347]: VERIFY OK: depth=1, CN=caEnBW2021
Sep 04 17:03:27 motis-dev ovpn-ovpn[1347]: VERIFY KU OK
Sep 04 17:03:27 motis-dev ovpn-ovpn[1347]: Validating certificate extended key usage
Sep 04 17:03:27 motis-dev ovpn-ovpn[1347]: ++ Certificate has EKU (str) TLS Web Server Authentication, expects TLS Web Server Authentication
Sep 04 17:03:27 motis-dev ovpn-ovpn[1347]: VERIFY EKU OK
Sep 04 17:03:27 motis-dev ovpn-ovpn[1347]: VERIFY OK: depth=0, CN=grs.smight-mgt.de
Sep 04 17:03:27 motis-dev ovpn-ovpn[1347]: Control Channel: TLSv1.2, cipher TLSv1.2 ECDHE-RSA-AES256-GCM-SHA384, 2048 bit RSA
Sep 04 17:03:27 motis-dev ovpn-ovpn[1347]: [grs.smight-mgt.de] Peer Connection Initiated with [AF_INET]185.126.28.27:1194
Sep 04 17:03:29 motis-dev ovpn-ovpn[1347]: SENT CONTROL [grs.smight-mgt.de]: 'PUSH_REQUEST' (status=1)
Sep 04 17:03:34 motis-dev ovpn-ovpn[1347]: SENT CONTROL [grs.smight-mgt.de]: 'PUSH_REQUEST' (status=1)
Sep 04 17:03:39 motis-dev ovpn-ovpn[1347]: SENT CONTROL [grs.smight-mgt.de]: 'PUSH_REQUEST' (status=1)
Sep 04 17:03:39 motis-dev ovpn-ovpn[1347]: PUSH: Received control message: 'PUSH_REPLY,ping 40,ping-restart 120,topology subnet,route-gateway 172.20.172.1,ifconfig 172.20.172.80 255.255.255.0'
Sep 04 17:03:39 motis-dev ovpn-ovpn[1347]: OPTIONS IMPORT: timers and/or timeouts modified
Sep 04 17:03:39 motis-dev ovpn-ovpn[1347]: OPTIONS IMPORT: --ifconfig/up options modified
Sep 04 17:03:39 motis-dev ovpn-ovpn[1347]: OPTIONS IMPORT: route-related options modified
Sep 04 17:03:39 motis-dev ovpn-ovpn[1347]: Data Channel MTU parms [ L:1559 D:1450 EF:59 EB:406 ET:0 EL:3 ]
Sep 04 17:03:39 motis-dev ovpn-ovpn[1347]: Outgoing Data Channel: Cipher 'AES-128-CBC' initialized with 128 bit key
Sep 04 17:03:39 motis-dev ovpn-ovpn[1347]: Outgoing Data Channel: Using 160 bit message hash 'SHA1' for HMAC authentication
Sep 04 17:03:39 motis-dev ovpn-ovpn[1347]: Incoming Data Channel: Cipher 'AES-128-CBC' initialized with 128 bit key
Sep 04 17:03:39 motis-dev ovpn-ovpn[1347]: Incoming Data Channel: Using 160 bit message hash 'SHA1' for HMAC authentication
Sep 04 17:03:39 motis-dev ovpn-ovpn[1347]: Preserving previous TUN/TAP instance: tun0
Sep 04 17:03:39 motis-dev ovpn-ovpn[1347]: Initialization Sequence Completed
```

ovpn.conf:
```
client
dev tun
proto tcp
persist-key
persist-tun
tls-client
remote-cert-tls server
verb 4
auth-nocache
mute 10
remote ovpn.chargehere.de
port 1194
auth SHA1
cipher AES-128-CBC
auth-user-pass /etc/openvpn/credentials
remote-cert-tls server
route 172.20.0.0 255.255.0.0
route 10.142.0.0 255.255.0.0

dhcp-option DOMAIN-ROUTE ctl.chargehere.de
script-security 2
up /etc/openvpn/update-resolv-conf
down /etc/openvpn/update-resolv-conf

<ca>
-----BEGIN CERTIFICATE-----
...
```